---
title: "Report_Analysis of HCC Merad Data (Magen 2022)"
author: "Abdenour ABBAS "
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  github_document:
    html_preview: true
editor_options: 
  chunk_output_type: inline
---


<!-- ```{css, echo=FALSE} -->
<!-- /* Section headers */ -->
<!-- h1 { font-size: 1.6em; } -->
<!-- h2 { font-size: 1.3em; } -->
<!-- h3 { font-size: 1.1em; } -->

<!-- /* Document title, author, date */ -->
<!-- .title  { font-size: 2em; font-weight: bold; text-align: center; } -->
<!-- .author { font-size: 1.2em; font-style: italic; text-align: center; } -->
<!-- .date   { font-size: 1em; color: #555; text-align: center; } -->
<!-- ``` -->


The goad of this analysis is to identify Langerhans Cells (LC) in public datasets and generate LC genesets that will be later used to compare tumor-DC activation states
```{r setup, message=FALSE}
library(knitr)
opts_chunk$set(fig.align = "center",
               fig.retina = 2,
               fig.width = 10,
               #cache = TRUE,
               #cache.lazy = F,
               #autodep=T,
               warning = T,
               message = T,
               eval=F,
               fig.path = "figures/",   # Dossier o√π stocker les images
               fig.keep = "all"
               # results = 'hide',
               # max.print = 10,
               # out.lines = 10
               )
# Load libraries
library(Seurat)
library(ggplot2)
library(dplyr)
library(magrittr)
library(parallel)
library(tidyverse)
library(qs)
library(presto)
library(simspec)
library(nichenetr)
library(patchwork)
library(nichenetr,quietly = T)
# Load utility scripts
config <- yaml::read_yaml("/pasteur/helix/projects/Dcai/Abdenour/analysis/utils/config.yaml")
source(paste0(config$path_to_scripts, "plot_heatmap2.R"))
source(paste0(config$path_to_scripts, "utils.R"))
source(paste0(config$path_to_scripts, "genes_related.R"))
# Force Seurat to use v3 assays 
options(Seurat.object.assay.version = 'v3') # https://github.com/satijalab/seurat/issues/8164
# Use custom colors in ggplot2
options(ggplot2.discrete.colour=pal)
options(ggplot2.discrete.fill=pal)
# scales::show_col(pal)
```

# 1. Wound Healing Dataset (GSE241132)
From paper PMID:39729995 (https://pubmed.ncbi.nlm.nih.gov/39729995/)
```{r Load Data}

```

```{r eval=F}
merged = qs::qread("../objects/human_skin_wound_healing_GSE241132.qs")
```

## 1.1. Subsetting myloid cells
```{r }
merged %<>% subset(subset= nFeature_RNA>500) %<>% subset(percent.mt <20) 


```

Read the already filtered object
```{r eval=T}

```

Let's exclude some gene lists from the clustering / visualization as they may hide relevant biological signals.
```{r Prepare gene masks, eval=T}
all_genes <- rownames(SeuratHCC_DC)
HB_genes <- c("HBB","HBA1","HBA2", "HBD","HBE1","HBG1","HBM","HBBP1","HBQ1","AHSP")
metallothionein=c('MT1HL1','MT2A','MT1E','MT1M','MT1A','MT1B','MT1F','MT1G','MT1H','MT1X')
rpgenes= grep("^RP[LS0-9]", all_genes, value=T) # 
other=c("MALAT1","XIST","JCHAIN")
hsp_genes=grep("^HSP", all_genes, value=T) 
dnaj_genes=grep("^DNAJ", all_genes, value=T)
stress_genes= c("JUN","FOS","FOSB","JUNB","ATF3","ATF4",dnaj_genes,hsp_genes)
mtgenes=grep("^MT-", all_genes, value=T) 
MTRN_genes=grep("^MTRN", all_genes, value=T)
IGgenes = grep("^IG[KLH]", all_genes, value=T)
HLAgenes = grep("^HLA-", all_genes, value=T)
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes
cell_cycle_genes = c(s.genes,g2m.genes)
genes_mask_clust = c(cell_cycle_genes,HB_genes, metallothionein, rpgenes,other,IGgenes,HLAgenes,MTRN_genes,mtgenes) #stress_genes
genes_mask_plot = c(HB_genes, metallothionein, rpgenes,other,IGgenes,MTRN_genes,mtgenes)#stress_genes
```

## 1.2. DimReduction 
```{r }
DefaultAssay(SeuratHCC_DC) = "RNA"
SeuratHCC_DC = NormalizeData(SeuratHCC_DC)
SeuratHCC_DC <- CellCycleScoring(SeuratHCC_DC, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)
SeuratHCC_DC = FindVariableFeatures(SeuratHCC_DC)
vargenes = setdiff(VariableFeatures(SeuratHCC_DC), genes_mask_clust)
SeuratHCC_DC <- ScaleData(SeuratHCC_DC, assay = "RNA", features = vargenes, vars.to.regress =  c("S.Score", "G2M.Score"))
SeuratHCC_DC <- RunPCA(SeuratHCC_DC,verbose = FALSE, npcs = 50, reduction.name = "pca", features = vargenes)
nPC= 12
ElbowPlot(SeuratHCC_DC, ndims = 50, reduction = "pca")+geom_vline(xintercept=nPC,  color="red")
SeuratHCC_DC <- RunUMAP(SeuratHCC_DC, reduction = "pca",min.dist = 0.5,spread = 1,  dims = 1:nPC, reduction.name = "umap")

DimPlot(SeuratHCC_DC, group.by = "subgroup")
FeaturePlot(SeuratHCC_DC, "CD207", cells=sample(Cells(SeuratHCC_DC)))
```

## 1.3. Clustering

```{r fig.height=9, fig.width=12}


# 36600 features across 65521
SeuratHCC_DC <- FindNeighbors(SeuratHCC_DC, reduction = "pca", dims = 1:nPC)
SeuratHCC_DC <- FindClusters(SeuratHCC_DC, resolution = 0.3)
# Cluster 6 are DC, subset object to cluster 6 and recluster
DimPlot(SeuratHCC_DC)
DimPlot(SeuratHCC_DC, group.by = "subgroup")
cells= sample(Cells(SeuratHCC_DC))
FeaturePlot(SeuratHCC_DC, features=c("FCER1A","CD1C","MKI67","CD1A","CD207","CCR7","MZB1"), cells = cells, ncol=4, reduction= "umap") & NoAxes()&coord_equal()
markers = presto::wilcoxauc(seu_sub)
markers_dist = markers %>% filter(!feature %in% genes_mask_clust) %>% arrange(desc(avgExpr)) %>% distinct(feature,.keep_all = TRUE) %>%  group_by(group) %>% arrange(desc(auc)) %>% slice_head(n = 30)
```


```{r}
devtools::install_github("MarioniLab/miloR", ref="devel")
```

## 1.4. Annotation and reordering of clusters
```{r eval=F}
VlnPlot(seu_sub, features =c("CD1C","FCER1A","CLEC10A","CD207","CD1A","EPCAM","CCR6","VCAN","FCN1","C5AR1","IDO1","CCR7","CLEC9A","CD14"), fill="ident",stack=T, flip=T, group.by = "annot_lev3")+NoLegend()+plot_layout(ncol=3)
p <- SCpubr::do_CorrelationPlot(sample = seu_sub,
                                group.by = "RNA_snn_res.0.2",
                                legend.position = "right")
# levels(p$data$x)
seu_sub$seurat_clusters = factor(seu_sub$RNA_snn_res.0.2, levels= c("4","1","2","0","3","5","6","7"))  # levels(p$data$x)

seu_sub$res.0.2 = plyr::mapvalues(seu_sub$seurat_clusters, from = levels(seu_sub$seurat_clusters), to =c(1:8))
seu_sub$annot_lev3 = plyr::mapvalues(seu_sub$res.0.2, from = c(1:8), to =c("MonoMac_1","MonoMac_2","MonoMac_3","DC2_CCR7","DC2_CD1A_CCR7","DC1","mature_DC","LC"))
seu_sub@active.ident = seu_sub$annot_lev3
```


## 1.4. Visualization
Heatmaps
```{r , fig.height=10.5, fig.width=12, eval=T}
markers = presto::wilcoxauc(SeuratHCC_myelo_Tumor, group_by="seurat_clusters")
top_markers= presto_topn_auc(markers,object= SeuratHCC_myelo_Tumor@active.ident,min_pct_in=10, genes_filter=genes_mask_plot, top_n = 7,minavgExpr=0.1)


SeuratHCC_myelo_Tumor$cell_names = colnames(SeuratHCC_myelo_Tumor)
cells= SeuratHCC_myelo_Tumor@meta.data %>% group_by(treatment_Resp) %>% slice_sample(n= 7342) %>% pull(cell_names)
genes= c("CD207","CD1A")
      
obj_small = subset(SeuratHCC_myelo_Tumor, cells=cells)
obj_small <- ScaleData(obj_small,features=c(genes,top_markers$feature))
plot_heatmap2(obj_small, markers =c(genes,c(top_markers$feature)),sort_var = c("seurat_clusters","subgroup","treatment_Resp"),
              anno_var = c("seurat_clusters","subgroup","treatment_Resp"),
              anno_colors = list(pal,pal,pal),
              hm_colors = c("purple","black","yellow"),
              hm_limit = c(-2,0,2),legend2show = c(T,T,T,T,T,F),padding = unit(c(0, 0, 0,2), "cm"),
              row_font_size = 7)

VlnPlot(seu_sub, features =c("CD1C","FCER1A","CLEC10A","CD207","CD1A","EPCAM","CCR6","ITGAE","HPGDS","IL18R1","SIGLEC9","CD72","LAMP3","IDO1","CCR7","CLEC9A","CD14"), fill="ident",stack=T, flip=T)+NoLegend()+plot_layout(ncol=3)

top_markers= presto_topn_auc(markers,object= seu_sub@active.ident,min_pct_in=10, max_pct_out = 100, genes_filter=genes_mask_clust, top_n = 100,minavgExpr=0.1)

seu_sub <- ScaleData(seu_sub,features=c(top_markers$feature))

plot_heatmap2(seu_sub,  markers = unique(c(top_markers$feature[top_markers$group=="LC"])),sort_var = c("annot_lev3","subtype","timepoint"),
              anno_var = c("annot_lev3","subtype","timepoint"),
              anno_colors = list(pal,pal,pal),
              hm_colors = c("purple","black","yellow"),
              hm_limit = c(-2,0,2),legend2show = c(T,T,T,T,T,F),padding = unit(c(0, 0, 0, 5), "cm"),
              row_font_size = 7)

markers = presto::wilcoxauc(seu_sub) 

markers$feature = UpdateSymbolsHuman(markers$feature)

top_markers = markers %>% filter(!feature %in% genes_mask_plot & avgExpr>0.1 & logFC>0.1  & pct_in>10) %>% group_by(group) %>% arrange(desc(auc),.by_group =T )

top_markers_distinct = markers %>% filter(!feature %in% genes_mask_plot &  avgExpr>0.1 & pct_in>10 & logFC>0.1)  %>% arrange(desc(avgExpr)) %>% distinct(feature,.keep_all = TRUE) %>% group_by(group) %>% arrange(desc(auc), .by_group =T)

# WriteXLS::WriteXLS(top_markers_distinct, "results/skin_wound_healing_myeloid_clusters_markers_distinct.xlsx")
# WriteXLS::WriteXLS(top_markers, "results/skin_wound_healing_myeloid_clusters_markers.xlsx")
```

```{r}
SeuratHCC_myelo_Tumor$cell_to_sample_ID
p1 = SeuratHCC_myelo_Tumor@meta.data %>% add_count(treatment_Resp, cell_to_sample_ID) %>% filter(n > 49)%>% 
plot_stats(
  plot_type="prop_fill",
  group_by = "seurat_clusters",group_prop = "treatment_Resp",
  text_size = 10,
  tilt_text = FALSE
)+scale_fill_discrete(name = "tissue")+ theme_cowplot()+RotatedAxis()+ggtitle(label="", subtitle="Relative contribution of each tissue type for each cluster \nafter balancing number of cells per tissue")
p1 + plot_spacer()

metadata= SeuratHCC_myelo_Tumor@meta.data %>% add_count(treatment_Resp, cell_to_sample_ID) %>% filter(n > 49)   

df <- data.frame(proportions(table(metadata$cell_to_sample_ID,metadata$seurat_clusters, metadata$treatment_Resp),1)) 
colnames(df) = c("cell_to_sample_ID", "seurat_clusters","treatment_Resp","Freq")


df  %>% 
  ggplot(aes(x=treatment_Resp, y=Freq)) +
  geom_boxplot(color="black",outlier.shape = NA,alpha = 0,width =0.5 ) +geom_point(shape=21,aes(fill=treatment_Resp),position = position_dodge(0.0),size=3) +
  ggpubr::stat_compare_means(method= "t.test",aes(label=..p.format..), paired=F)+ theme(text = element_text(size=10))+theme(axis.text.x = element_text(angle = 45, hjust = 1)) +theme_cowplot() + ggtitle("Frequency ", subtitle = "Only patiets with at least 50 cells per sample \n t.test")+NoLegend()+RotatedAxis()+ facet_grid(cols = vars(seurat_clusters))
```


## 1.5. Saving Data
```{r}
# qsave(seu_sub, "human_skin_wound_healing_GSE241132_Myeloid_filtered_processed.qs", nthreads = 8)
# seu_sub = qs::qread("human_skin_wound_healing_GSE241132_Myeloid_filtered_processed.qs", nthreads = 8)
```

#########################################################################################################
#########################################################################################################

```{r}
SeuratHCC_myelo_Tumor = subset(SeuratHCC_myelo, tissue=="Tumor")

sce <- as.SingleCellExperiment(SeuratHCC_myelo_Tumor)

sce_milo <- Milo(sce)
miloR::graph(sce_milo) <- miloR::graph(buildFromAdjacency(SeuratHCC_myelo_Tumor@graphs$RNA_snn, k=20))
sce_milo = makeNhoods(sce_milo, prop=0.2, k=20, d=nPC,refined = T,refinement_scheme="graph", reduced_dims="css")
plotNhoodSizeHist(sce_milo)

sce_milo <- countCells(x=sce_milo, meta.data = as.data.frame(colData(sce_milo)), samples="cell_to_sample_ID")
milo_design <- data.frame(colData(sce_milo))[,c("cell_to_sample_ID", "treatment_Resp")]

milo_design <- distinct(milo_design)
rownames(milo_design) <- milo_design$cell_to_sample_ID

sce_milo <- calcNhoodDistance(sce_milo, d=nPC)

da_results <- testNhoods(sce_milo, design = ~ treatment_Resp, design.df = milo_design,fdr.weighting="graph-overlap")
     
da_results <- annotateNhoods(sce_milo, da_results, coldata_col = "seurat_clusters")

plotDAbeeswarm(da_results, group.by = "seurat_clusters")
```

# Run Milo
```{r fig.height=8, fig.width=10}
library(miloR)
library(SummarizedExperiment)
library(SingleCellExperiment)
# bladder_fibs = readRDS( "../../R_objects_etc/2209_bladder_fibs_Takeda_Galsky_Chen_SoupX.rds")

SeuratHCC_DC_Tumor = subset(SeuratHCC_DC, tissue=="Tumor")

sce <- as.SingleCellExperiment(SeuratHCC_DC_Tumor)

filter(!is.na(treatment_Resp))


sce_milo <- Milo(sce)
miloR::graph(sce_milo) <- miloR::graph(buildFromAdjacency(SeuratHCC_DC_Tumor@graphs$RNA_snn, k=20))
sce_milo = makeNhoods(sce_milo, prop=0.2, k=20, d=nPC,refined = T,refinement_scheme="graph", reduced_dims="css")
plotNhoodSizeHist(sce_milo)

sce_milo <- countCells(x=sce_milo, meta.data = as.data.frame(colData(sce_milo)), samples="cell_to_sample_ID")
milo_design <- data.frame(colData(sce_milo))[,c("cell_to_sample_ID", "treatment_Resp")]

milo_design <- distinct(milo_design)
rownames(milo_design) <- milo_design$cell_to_sample_ID

sce_milo <- calcNhoodDistance(sce_milo, d=nPC)

da_results <- testNhoods(sce_milo, design = ~ treatment_Resp, design.df = milo_design,fdr.weighting="graph-overlap")
     
da_results <- annotateNhoods(sce_milo, da_results, coldata_col = "seurat_clusters")


da_results$seurat_clusters <- ifelse(da_results$seurat_clusters < 0.8, "Mixed", da_results$seurat_clusters)
plotDAbeeswarm(da_results, group.by = "seurat_clusters")
head(da_results)

sce_milo <- buildNhoodGraph(sce_milo)
names(reducedDims(sce_milo))
## Plot single-cell UMAP

umap_pl1 <- scater::plotReducedDim(sce_milo, dimred = "UMAP_REG_FIBS_CSS", colour_by="annotation_lev4", text_by = "annotation_lev4", 
                          text_size = 3, point_size=0.5) +NoAxes()+guides(fill="none")+  NoLegend()+coord_fixed(ratio = 1.25)

umap_pl2 <- scater::plotReducedDim(sce_milo, dimred = "UMAP_REG_FIBS_CSS", colour_by="tissue", text_by = "tissue", 
                          text_size = 3, point_size=0.5)+NoAxes()+coord_fixed(ratio = 1.25)

## Plot neighbourhood graph
library(scales)
nh_graph_pl <- plotNhoodGraphDA(sce_milo, da_results, layout="UMAP_REG_FIBS_CSS",alpha=0.1) + scale_fill_gradient2(low = muted("blue"),mid = "white",high = muted("red"))+coord_fixed(ratio = 1.25)+guides(fill = guide_legend("logFC"))

da_results$annotation_lev4 = factor(da_results$annotation_lev4, levels=levels(bladder_fibs$annotation_lev4))
da_results$annotation_lev2 = factor(da_results$annotation_lev2, levels=levels(bladder_fibs$annotation_lev2))
plot_grid(plotlist=list(umap_pl2,umap_pl1,nh_graph_pl),align="hv")
p1=plotDAbeeswarm(da_results, group.by = "annotation_lev4",alpha=0.2)+scale_color_gradient2(low = muted("blue"),mid = "white",high = muted("red"))
p2=plotDAbeeswarm(da_results, group.by = "annotation_lev2",alpha=0.2)+scale_color_gradient2(low = muted("blue"),mid = "white",high = muted("red"))
(p1+ coord_flip())+p2
nh_graph_pl/plot_spacer()
group.by = "annotation_lev4"
alpha=0.5
 beeswarm_pos <- ggplot_build(da_results %>% mutate(is_signif = ifelse(SpatialFDR < 
    alpha, 1, 0)) %>% arrange(annotation_lev4) %>% ggplot(aes(annotation_lev4, 
    logFC)) + ggbeeswarm::geom_quasirandom())
  pos_x <- beeswarm_pos$data[[1]]$x
  pos_y <- beeswarm_pos$data[[1]]$y
  n_groups <- unique(da_results$annotation_lev4) %>% length()
  
 p1= da_results %>% mutate(is_signif = ifelse(SpatialFDR < alpha, 
    1, 0)) %>% mutate(log_FC = ifelse(is_signif == 
    1, logFC, NA)) %>% arrange(annotation_lev4) %>% mutate(Nhood = factor(Nhood, 
    levels = unique(Nhood))) %>% mutate(pos_x = pos_x, pos_y = pos_y) %>% 
    ggplot(aes(pos_x, pos_y, color = log_FC)) + 
    guides(guide_legend("logFC")) + xlab(group.by) + ylab("Log Fold Change") + 
    scale_x_continuous(breaks = seq(1, n_groups), labels = setNames(levels(da_results$annotation_lev4), 
      seq(1, n_groups))) + geom_point() + 
    theme_bw(base_size = 22) + theme(strip.text.y = element_text(angle = 0))+ RotatedAxis()+scale_color_gradient2(low = muted("blue"),mid = "white",high = muted("red")) + 
   theme(plot.margin=margin(l=20,unit = "pt"))

 p1 / plot_spacer()

 do_FeaturePlot(bladder_fibs_ds_tissue, "IL11",reduction = "umap_reg_fibs_CSS", split.by = "tissue",viridis_color_map = "B",pt.size = 0.5,viridis_direction = -1)
 
```

```{r fig.height=7}
sce_milo <- buildNhoodGraph(sce_milo)

## Find groups
da_results <- groupNhoods(sce_milo, da_results, max.lfc.delta = 1.5,overlap=3)
tabl(da_results$NhoodGroup)

# da_results$NhoodGroup = factor(da_results$NhoodGroup, levels=as.character(1:12))
plotNhoodGroups(sce_milo, da_results, layout="UMAP_REG_FIBS_CSS") + scale_fill_manual(values=pal, na.value = "white",labels=as.character(1:15))
plotDAbeeswarm(da_results, "NhoodGroup")+scale_color_gradient2(low = muted("blue"),mid = "white",high = muted("red"))

groups_res <- da_results[da_results$NhoodGroup,]
colData(sce_milo)[unlist(nhoodIndex(sce_milo)[da_results$Nhood]), "NhoodGroup"] <- da_results$NhoodGroup
tabl(colData(sce_milo)[unlist(nhoodIndex(sce_milo)[da_results$Nhood]), "NhoodGroup"] )
tabl(da_results$NhoodGroup)
```